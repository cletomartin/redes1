
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Network layer &#8212; Computer Networks I</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'network';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Data-link layer" href="data-link.html" />
    <link rel="prev" title="Transport layer" href="transport.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="main.html">
  
  
  
  
  
  
    <p class="title logo__title">Computer Networks I</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="main.html">
                    Computer Networks I
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Network architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="application.html">Application layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="transport.html">Transport layer</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Network layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="data-link.html">Data-link layer</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/network.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Network layer</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ip-protocol">IP protocol</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#format">Format</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fragmentation">Fragmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#addressing">Addressing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subnetting">Subnetting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-and-management-protocols">Configuration and management protocols</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#icmp">ICMP</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#errors">Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#requests">Requests</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dhcp">DHCP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ip-routing">IP routing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#delivery-methods">Delivery methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forwarding">Forwarding</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#routing-tables">Routing tables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-routing">Dynamic routing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="network-layer">
<h1>Network layer<a class="headerlink" href="#network-layer" title="Link to this heading">#</a></h1>
<p>This lesson describes in depth the network layer. It descripts the IP addressing and routing mechanisms too.
You can find the slides <a class="reference download internal" download="" href="_downloads/21aa61b227b4c0dae4862a599d5031c3/network.odp"><span class="xref download myst">here</span></a>.</p>
<p>Under the transport layer, the network layer is used mainly for delivering data between hosts
as long as the hosts are connected through a set of inter-networks.
The following are the main features of the network layer:</p>
<ul class="simple">
<li><p><em>Payload encapsulation</em>: data from the transport layer is encapsulated and delivered to any point of the internet.</p></li>
<li><p><em>Routing</em>: the data packets are sent <em>host-to-host</em> although they can travel through other hosts or networks.
What route a packet takes is a decision made with the help of <em>routing protocols</em> and it might the case that packets of the same transport flow go through different routes (<em>connectionless</em>).</p></li>
<li><p><em>Forwarding</em>: the <em>routing nodes</em> of the network layer are known <em>routers</em>.
They perform packet forwarding: decide what is the next hop based on the <em>routing table</em>.</p></li>
<li><p><em>Best-effort delivery</em>: the network layer is <em>unreliable</em>.
There is no guarantee that a packet has arrived to destination nor it arrived in the right order.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the network example:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">Link</span></code> nodes are devices that only operates at data-link layer. They just connect nodes directly.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">Intermediate</span> <span class="pre">system</span></code> are nodes that can connect networks.</p></li>
<li><p>A datagram going from the node <code class="docutils literal notranslate"><span class="pre">A</span></code> to any of the <code class="docutils literal notranslate"><span class="pre">End</span> <span class="pre">system</span></code> follows the encapsulation/decapsulation trace at the bottom of the image.
Each node of the network uses up-to network layer.</p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this example, the <em>connectionless</em> concepto is shown clearly.
Packets 1, 2, 3 and 4 take different routes and arrive out of order.
Note that this is a packet-switched network where information is transmitted as individual datagrams.</p>
</div>
<section id="ip-protocol">
<h2>IP protocol<a class="headerlink" href="#ip-protocol" title="Link to this heading">#</a></h2>
<p>The Inter-network Protocol (IP) is the standard network protocol of the Internet.
It can be used to interconnect different types of networks (made out of different technologies) as long as the nodes understand IP messages.</p>
<p>In this section we are going the dive into the format of the IP datagrams, the fragmentation mechinism, how IP addresses work and how they can be strucuture using subnetting.</p>
<section id="format">
<h3>Format<a class="headerlink" href="#format" title="Link to this heading">#</a></h3>
<p>The IP datagram has a maximum length of <span class="math notranslate nohighlight">\(2^16\)</span> bytes:</p>
<ul class="simple">
<li><p>The minimum header length is 20 bytes. The header can be extended 40 bytes more with options.</p></li>
<li><p>The rest is reserved to the payload.</p></li>
</ul>
<p>These are the fields of the IP header:</p>
<ul>
<li><p><em>Version</em>: 4 bits for specifying the IP version. <code class="docutils literal notranslate"><span class="pre">4</span></code> for IPv4 and <code class="docutils literal notranslate"><span class="pre">6</span></code> for IPv6.</p></li>
<li><p><em>Internet Header Length (IHL)</em>: 4 bits for specifying the length of the IP header in 4-byte words.</p></li>
<li><p><em>Type of Service</em>: 8 bits for helping to service differentiation (also known as <em>quality of service</em>)</p></li>
<li><p><em>Total Length</em>: 16 bits for specifying the total length of the IP datagram, including the header.</p></li>
<li><p><em>Identification</em>: 16 bits for identifying the datagram if it belongs to a fragmented one.
If a datagram is fragmented, this field is the same for all the fragments.</p></li>
<li><p><em>Don’t Fragment (DF)</em>: 1 bit to tell routers the datagram should not be fragmented.</p></li>
<li><p><em>More Fragments (MF)</em>: 1 bit to tell routers this datagram is not the last one of a serie of fragmented datagrams.</p></li>
<li><p><em>Offset</em>: 13 bits to tell the position of this datagram in the series of fragmented datagrams.
It is expressed as a value of 8-byte words, so:</p>
<ul class="simple">
<li><p>There can only be <span class="math notranslate nohighlight">\(2^8\)</span> fragments.</p></li>
<li><p>The size of a fragment must be mutiple of 8, except for the last one.
The first fragment has this value always set to 0.</p></li>
</ul>
</li>
<li><p><em>Time-to-live (TTL)</em>: 8 bits to tell the router if a datagram needs to be discarded.
Everytime a router forwards a datagram, it decreases the TTL value.
If the value is set to 0, the packet is discarded by the router.</p></li>
<li><p><em>Protocol</em>: 8 bits to tell what protocol is encapsulated:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Value</p></th>
<th class="head"><p>Procotol</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>1</p></td>
<td><p>ICMP</p></td>
</tr>
<tr class="row-odd"><td><p>2</p></td>
<td><p>IGMP</p></td>
</tr>
<tr class="row-even"><td><p>4</p></td>
<td><p>IPv4</p></td>
</tr>
<tr class="row-odd"><td><p>6</p></td>
<td><p>TCP</p></td>
</tr>
<tr class="row-even"><td><p>17</p></td>
<td><p>UDP</p></td>
</tr>
<tr class="row-odd"><td><p>89</p></td>
<td><p>OSPF</p></td>
</tr>
</tbody>
</table>
</li>
<li><p><em>Checksum</em>: 16 bits for detecting errors of the header.
It needs to be checked on every hop of the route.
The payload is not included and it is left to the upper layers to perform their own check.</p>
<p>The field is computed by dividing the hearder in 2-byte fields, sum them all and complement the sum.
If the final sum overflows, it is wrapped.</p>
</li>
<li><p><em>Source IP</em>: 32 bits for the source IP address.</p></li>
<li><p><em>Destination IP</em>: 32 bits for the destination IP address.</p></li>
<li><p><em>Options</em>: up-to 40 bytes is reserved for options that are used in specific scenarios and debugging.
Although it is not mandatory to use options in the IP protocol, all IP devices should handle them if they are present.
An option has the following structure:</p>
<ul class="simple">
<li><p><em>Code</em>: 8 bits for indicating the option</p>
<ul>
<li><p><em>Copy</em>: 1 bit for indicating whether the option needs to be copy or not to all the fragments.</p></li>
<li><p><em>Class</em>: 2 bits for indicating the general category of the option.</p></li>
<li><p><em>Number</em>: 5 bits for identifying the option. There are <span class="math notranslate nohighlight">\(2^5\)</span> options avaiable but only a few of them are frequently used.</p></li>
</ul>
</li>
<li><p><em>Length</em>: 8 bits for specifiying the length of the data of this option.</p></li>
<li><p><em>Data</em>: variable-length field containing the data of the option.</p></li>
</ul>
</li>
</ul>
</section>
<section id="fragmentation">
<h3>Fragmentation<a class="headerlink" href="#fragmentation" title="Link to this heading">#</a></h3>
<p>All networks are not the same.
Each network may have its own features and capabilities and an important one is the <em>Maximum Transfer Unit</em> (MTU).
This is the maximum size of a frame that can be transmitted through a link. This value might be different from one network to another,
so routers will need to adapt the IP datagram size to it.</p>
<p>This process of routers slicing IP datagrams is known as <em>fragmentation</em> and the IP protocol provides support to handle the problems associated with it.
At destination, the fragments are reassembled so the original IP datagram is built.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The fragmentation can only happen at destination because intermediate routers might not see all the fragments passing through them.
Since IP datagrams might take different routes, because they are independent datagrams, only the destination is capable of reassembling them.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The fragmentation example should be explained as follows:</p>
<ul class="simple">
<li><p>A datagram is going to be sent from <code class="docutils literal notranslate"><span class="pre">source</span></code> to <code class="docutils literal notranslate"><span class="pre">destination</span></code>.</p></li>
<li><p>The router <code class="docutils literal notranslate"><span class="pre">R1</span></code> will have to fragment it in 3 fragments (<span class="math notranslate nohighlight">\(4020 / 1420 = 2.5\)</span> so we need 3 fragments).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">f1</span></code> and <code class="docutils literal notranslate"><span class="pre">f3</span></code>  will no need more fragmentation because the MTU will be enough for the rest of the hops.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">f2</span></code> requires one more fragmentation step in <code class="docutils literal notranslate"><span class="pre">R4</span></code> as it goes to a smaller MTU.</p></li>
<li><p>In total, 5 fragments will arrive.</p></li>
</ul>
<p>In the following slide, you should explain how the data is distributed across the different fragments:</p>
<ul>
<li><p>An important aspect to take into account is that if the IP header is 20 bytes, these 20 bytes must be <em>always</em> included.
So <code class="docutils literal notranslate"><span class="pre">R1</span></code> will only be able to send 1400 bytes (plus 20 bytes of the IP header) through the bottom network.
This is why the <code class="docutils literal notranslate"><span class="pre">f1</span></code> contains 1400 bytes (from 0 to 1399), <code class="docutils literal notranslate"><span class="pre">f2</span></code> contains 1400 bytes (from 1400 to 2799) and <code class="docutils literal notranslate"><span class="pre">f3</span></code> contains 1200 bytes (from 2800 to 3999).</p>
<p>The identification field for all these fragments are the same as the original datagram (14567).</p>
<p>The total length of each fragment changes to reflect the new size of the datagrams: 1420 (1400 + 20 for the header) for <code class="docutils literal notranslate"><span class="pre">f1</span></code> and <code class="docutils literal notranslate"><span class="pre">f2</span></code>, and 1220 for <code class="docutils literal notranslate"><span class="pre">f3</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">M</span></code> bit is set to 1 for <code class="docutils literal notranslate"><span class="pre">f1</span></code> and <code class="docutils literal notranslate"><span class="pre">f2</span></code> but is set to 0 for <code class="docutils literal notranslate"><span class="pre">f3</span></code>. This bit indicates if there is more fragments to come. <code class="docutils literal notranslate"><span class="pre">f1</span></code> and <code class="docutils literal notranslate"><span class="pre">f2</span></code> has more fragments to come but <code class="docutils literal notranslate"><span class="pre">f3</span></code> is the last one.</p>
<p>The last field that needs to be kept into account is the <em>fragmentation offset</em>.
This field is calculated based on the first byte number of data of each fragment divided by 8:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">f1</span></code>: <span class="math notranslate nohighlight">\(0 / 8 = 0\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">f2</span></code>: <span class="math notranslate nohighlight">\(1400 / 8 = 175\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">f3</span></code>: <span class="math notranslate nohighlight">\(2800 / 8 = 350\)</span></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">f2</span></code> is split in 2 more fragments: <code class="docutils literal notranslate"><span class="pre">f2.1</span></code> and <code class="docutils literal notranslate"><span class="pre">f2.2</span></code>. This would be a good exercise to calculate the different fields with the students.</p>
<p>The original size of the datagram is 1400 bytes (plus 20 bytes for the header).
The MTU is 820, so we can split this datagram is 2: <code class="docutils literal notranslate"><span class="pre">f2.1</span></code> of size 800 bytes (from 1400 to 2199) and <code class="docutils literal notranslate"><span class="pre">f2.2</span></code> of 600 bytes (from 2200 to 2799).</p>
<p>The idenfication field remains the same.</p>
<p>The total length now is set to 820 and 620 respectively.</p>
<p>The fragment offset remains the same for <code class="docutils literal notranslate"><span class="pre">f2.1</span></code> (<span class="math notranslate nohighlight">\(1400 / 8\)</span> was already calculated) but it is different for <code class="docutils literal notranslate"><span class="pre">f2.2</span></code> (<span class="math notranslate nohighlight">\(2200 / 8 = 275\)</span>).</p>
<p>An important detail is that the <code class="docutils literal notranslate"><span class="pre">M</span></code> bit is 1 too all of them. <code class="docutils literal notranslate"><span class="pre">f2.2</span></code> is <em>not</em> the last fragment of the original IP datagram,
it is just another fragment within</p>
</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The DIY examples:</p>
<ul>
<li><p>We use <code class="docutils literal notranslate"><span class="pre">ping</span></code> for sending 1 ICMP packet with 4000 bytes of data. Note that the MTU is 1500 bytes.
<code class="docutils literal notranslate"><span class="pre">tshark</span></code> is used for capturing traffic. It shows that the datagram is split in 3 fragments.</p>
<p><code class="docutils literal notranslate"><span class="pre">ping</span></code> is actually sending 4028 bytes: 4000 bytes of data, 20 bytes for the IP header and 8 bytes corresponding to the ICMP header.</p>
</li>
<li><p>In this case, the ICMP packet contains 3992 bytes of data, thus it is sent 4020 bytes (including the IP and ICMP headers).</p></li>
<li><p>Here we use a Python library called scapy for generating an IP datagram. We add a payload of 7000 bytes and this generates 5 fragments.
You can find the <a class="reference download internal" download="" href="_downloads/7f46341be83b165c103e70d9bdbfbf47/frag.py"><span class="xref download myst">code here</span></a>.</p></li>
</ul>
</div>
</section>
<section id="addressing">
<h3>Addressing<a class="headerlink" href="#addressing" title="Link to this heading">#</a></h3>
<p>The IP protocol addresses are 32-bit integers.
Each node of an IP network will have, at least, one IP address that will identify it <em>uniquely</em> within the network.
Note that a node can belong to multiple networks (like a router) so it could have multiple IP addresses associated to it.</p>
<p>The addresses are hierarchical, similar to a postal address (e.g. country/city/street).
The 32 bits that make the IP address are divided in 2 groups:</p>
<ul class="simple">
<li><p><em>Prefix</em>: that identifies the <em>network</em>.</p></li>
<li><p><em>Suffix</em>: that identifies the <em>host</em> within that network.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For example, the address <code class="docutils literal notranslate"><span class="pre">192.168.1.128</span></code> with a prefix of n=24, the network is <code class="docutils literal notranslate"><span class="pre">192.168.1</span></code> and the host is <code class="docutils literal notranslate"><span class="pre">128</span></code> within that network.
However, if n=8 the network is <code class="docutils literal notranslate"><span class="pre">192</span></code> and the host would be <code class="docutils literal notranslate"><span class="pre">168.1.128</span></code>.</p>
</div>
<p>There are a few special addresses:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">0.0.0.0</span></code>: indicates <em>this host</em>. Its meaning might vary depending the context it is used.
For example, it might indicate that a service can listen on <em>any</em> interface of the host.
In DHCP, as we will see, refers to the host that is requesting an IP address.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">255.255.255.255</span></code>: is the broadcast address. Any message send to this direction will be received by all hosts.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">X.X...0000</span></code>: is the network address. It is the first address of the range defined by the prefix.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">X.X...1111</span></code>: is the broadcast address within the network. It is the last address of the range defined by the prefix.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">0.0...X</span></code>: identifies a host within the network.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">127.0.0.0</span></code>: the loopback network used for testing network applications without the need of using real Internet connection.</p></li>
</ul>
<p>Originally, the Internet was divided in classes:</p>
<ul class="simple">
<li><p><em>Class A</em>: start with <code class="docutils literal notranslate"><span class="pre">0</span></code> and uses 8 bits for the prefix.</p></li>
<li><p><em>Class B</em>: start with <code class="docutils literal notranslate"><span class="pre">10</span></code> and uses 16 bits for the prefix.</p></li>
<li><p><em>Class C</em>: start with <code class="docutils literal notranslate"><span class="pre">110</span></code> and uses 24 bits for the prefix.</p></li>
<li><p><em>Class D</em>: start with <code class="docutils literal notranslate"><span class="pre">1110</span></code> and use for multicast addresses.</p></li>
<li><p><em>Class E</em>: start with <code class="docutils literal notranslate"><span class="pre">1111</span></code> and reserved for future use.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Classful addressing is now <em>obsolete</em> because it couldn’t fit well to address demand.
The class A addresses provide a ver large range of hosts that can be in the network (<span class="math notranslate nohighlight">\(2^24\)</span>)
but only 128 networks can be defined.
The class C only provides 256 host addresses but the next step (the class B) provides <span class="math notranslate nohighlight">\(2^16\)</span>.
Organisations and companies that need to go from C to D might not make a good use of all that range.</p>
<p>In general terms, classful addressing makes the address ranges to be not well used and do not adapt to the real demand.</p>
</div>
<p>Currently, the Internet uses classless addressing, where we just need to fix the prefix lentgh <em>n</em> to fully define a network address.
We can define this <em>n</em> as we wish, based on our needs, so very little amount of addresses will be wasted.
The notation of an address will be: <code class="docutils literal notranslate"><span class="pre">XXX.XXX.XXX.XXX/n</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the example of <code class="docutils literal notranslate"><span class="pre">167.199.170.82/27</span></code>:</p>
<ul class="simple">
<li><p>There allows a block of <span class="math notranslate nohighlight">\(2^5\)</span> addresses.</p></li>
<li><p>The first one is the network address: <code class="docutils literal notranslate"><span class="pre">167.199.170.64</span></code></p></li>
<li><p>The last one is the network broadcast address: <code class="docutils literal notranslate"><span class="pre">167.199.170.95</span></code></p></li>
<li><p>Note that <code class="docutils literal notranslate"><span class="pre">167.199.170.64</span></code> and <code class="docutils literal notranslate"><span class="pre">167.199.170.95</span></code> are <em>not</em> used for hosts.
So for addressing hosts in that range we would have <span class="math notranslate nohighlight">\(2^5 - 2\)</span> addresses.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">167.199.170.82</span></code> is the address of the host and, for example, <code class="docutils literal notranslate"><span class="pre">167.199.170.195</span></code> do not belong to this network.</p></li>
</ul>
</div>
<p>Routers forward datagrams from one network to another, depending on the destination IP.
This is an operation that must be quick because they will be doing <em>a lot</em>.
In order to know what is the network address of a given IP can use the concept of <em>network mask</em>.
The mask is a 32-bit number where the first <em>n</em> bits (the length of the prefix) are set to 1 and the rest to 0.
For example: <code class="docutils literal notranslate"><span class="pre">167.199.170.82/27</span></code> has a mask of <code class="docutils literal notranslate"><span class="pre">11111111.11111111.11111111.11100000</span></code>.
By using this mask, it is only required an <code class="docutils literal notranslate"><span class="pre">AND</span></code> operation to get the network address:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">167.199.170.82</span>   <span class="o">-</span>  <span class="mf">10100111.11000111.10101010.01010010</span>
<span class="mf">255.255.255.224</span>  <span class="o">-</span>  <span class="mf">11111111.11111111.11111111.11100000</span>
<span class="o">-------------------------------------------------------</span>
                    <span class="mf">10100111.11000111.10101010.01000000</span>  <span class="o">-</span> <span class="mf">167.199.170.64</span>
</pre></div>
</div>
<p>In classless addressing, the IP must be provided along its mask. That way, the host is fully defined in the Internet.
<code class="docutils literal notranslate"><span class="pre">IP/mask</span></code> format is known as <em>CIDR notation</em>.
Classless Inter-Domain Routing (CIDR) is a method of allocating IP addresses which was created for replacing the classful approach of the Internet.
IANA delegates the assignation of the IP addresses world-wide by providing different ranges to local entities like ISPs or similar companies.
As we have seen, CIDR is based on <em>VLSM</em> where the network mask can be of different length to provide accurate ranges for different needs without wasting too many IPs.</p>
<p>There has been defined a few IP addresses for private use.
These means that these IP ranges will not go through the public Internet and can be used within an organisation:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">10/8</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">172.16/12</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">192.168/16</span></code></p></li>
</ul>
<p>There are also the <em>link-local addresses</em> that are used for automatic configuration of the hosts in a network: hosts without an IP address select an IP address from the range <code class="docutils literal notranslate"><span class="pre">169.254/16</span></code>.
Although these addresses will never go to the Internet, they can be useful for contacting neighbours though.</p>
</section>
<section id="subnetting">
<h3>Subnetting<a class="headerlink" href="#subnetting" title="Link to this heading">#</a></h3>
<p>Subnetting is the process of subdividing a network into smaller networks so the IPs provided by the original range can be better used.
If you ever get assigned to a class A or B, it is clear that the amount of hosts available in that range could be excessive for your needs.
Using subnetting you can split the available space into sub-networks.
Each sub-network could also be split in other sub-sub-networks and so on.
This way, it is possible to organise a big range of IPs and make better use of the available addresses for hosts on each network.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the example:</p>
<ul class="simple">
<li><p>The orginal n is 16 (a class B network).</p></li>
<li><p>We use 4 bits more for creating subnets.
This means we can have up-to 16 subnets (<span class="math notranslate nohighlight">\(2^4\)</span>).</p></li>
<li><p>Each sub-net will be able to address <span class="math notranslate nohighlight">\(2^{32 - 20} - 2\)</span> hosts.
Note we substract 2 because we need network and broadcast addresses.</p></li>
</ul>
</div>
<p>Because we <em>extend</em> the prefix length to create subnets, the number of possible subnets will be always power of 2.
I can be applied to any block as long as it is not used already.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the example we need to build 4 subnetworks for the network 141.14.0.0/24.
This means that we will need to use 2 bits more, so the resulting subnets will be <code class="docutils literal notranslate"><span class="pre">/26</span></code> but with different values of course.</p>
<ul class="simple">
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">00</span> <span class="pre">000000</span></code>/26</p>
<ul>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">00</span> <span class="pre">000000</span></code> -&gt; 141.14.0.0/26 net</p></li>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">00</span> <span class="pre">111111</span></code> -&gt; 141.14.0.63/26 brd</p></li>
</ul>
</li>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">01</span> <span class="pre">000000</span></code>/26</p>
<ul>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">01</span> <span class="pre">000000</span></code> -&gt; 141.14.0.64/26 net</p></li>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">01</span> <span class="pre">111111</span></code> -&gt; 141.14.0.127/26 brd</p></li>
</ul>
</li>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">10</span> <span class="pre">000000</span></code>/26</p>
<ul>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">10</span> <span class="pre">000000</span></code> -&gt; 141.14.0.128/26 net</p></li>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">10</span> <span class="pre">111111</span></code> -&gt; 141.14.0.191/26 brd</p></li>
</ul>
</li>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">11</span> <span class="pre">000000</span></code>/26</p>
<ul>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">11</span> <span class="pre">000000</span></code> -&gt; 141.14.0.192/26 net</p></li>
<li><p>141.14.0.<code class="docutils literal notranslate"><span class="pre">11</span> <span class="pre">111111</span></code> -&gt; 141.14.0.255/26 brd</p></li>
</ul>
</li>
</ul>
</div>
</section>
</section>
<section id="configuration-and-management-protocols">
<h2>Configuration and management protocols<a class="headerlink" href="#configuration-and-management-protocols" title="Link to this heading">#</a></h2>
<p>In this section we are going to explain two important protocols that help the network layer in some sense.</p>
<section id="icmp">
<h3>ICMP<a class="headerlink" href="#icmp" title="Link to this heading">#</a></h3>
<p>IP is a network protocol that delivers datagrams. This delivery, even it is not reliable, requires some basic mechanisms to detect errors, network congestions, etc.
The Internet Control Message Protocol (ICMP) works on top of IP to provide:</p>
<ul class="simple">
<li><p><em>Error detection</em> at multiple levels.</p></li>
<li><p><em>Information</em> about the network status (hosts, routers, etc).</p></li>
</ul>
<p>Each ICMP message is encapsulated in an IP datagram and the message format is as follows:</p>
<ul>
<li><p><em>ICMP Header</em>: the header is 8-byte long.</p>
<ul>
<li><p><em>Type</em>: 1 byte for the type of the ICMP message.
An ICMP message can contain different information based on the type, a <em>request</em>, an <em>error</em>, a <em>reply</em>, etc.
Depending of the value of this field it would be one or the other.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Echo Reply</p></td>
</tr>
<tr class="row-odd"><td><p>8</p></td>
<td><p>Echo Request</p></td>
</tr>
<tr class="row-even"><td><p>3</p></td>
<td><p>Destination Unreachable</p></td>
</tr>
</tbody>
</table>
</li>
<li><p><em>Code</em>: 1 byte for the subtype of the ICMP message.
For example code <code class="docutils literal notranslate"><span class="pre">1</span></code> of type <code class="docutils literal notranslate"><span class="pre">3</span></code> means the destination <em>port</em> was unreachable,
whereas code <code class="docutils literal notranslate"><span class="pre">1</span></code> of the same type means destination <em>host</em> was unreachable.</p></li>
<li><p><em>Checksum</em>: 2 bytes for the checksum that is calculated like the IP’s checksum field.</p></li>
<li><p><em>Rest of header</em>: 4 bytes more whose value will depend on the specific ICMP message.</p></li>
</ul>
</li>
<li><p><em>ICMP Data</em>: the content of the message.</p></li>
</ul>
<section id="errors">
<h4>Errors<a class="headerlink" href="#errors" title="Link to this heading">#</a></h4>
<p>The ICMP errors are used for signalling problems.
They are always reported from the place they are generated <em>back to the source host</em>.
There are some special cases in which errors are not reported:</p>
<ul class="simple">
<li><p>An error of an ICMP message.</p></li>
<li><p>IP datagrams failures with special addresses like 127.0.0.1 or multicast.</p></li>
<li><p>A failure of an IP fragment that is not the first one.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In all these cases, it is possible to generate lots of error messages.</p>
</div>
<p>For reference, the ICMP error messages have the following values in the ICMP Data field:</p>
<ol class="arabic simple">
<li><p>The IP header of the affected datagram, and</p></li>
<li><p>the first 8 bytes of the affected datagram’s payload.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the <a class="reference external" href="https://www.rfc-editor.org/rfc/rfc792">RFC 792</a> we can read:</p>
<div class="docutils">
<p>Internet Header + 64 bits of Data Datagram</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>  The internet header plus the first 64 bits of the original
  datagram&#39;s data.  This data is used by the host to match the
  message to the appropriate process.  If a higher level protocol
  uses port numbers, they are assumed to be in the first 64 data
  bits of the original datagram&#39;s data.
</pre></div>
</div>
</div>
</div>
<p>Some examples of ICMP errors:</p>
<ul class="simple">
<li><p><em>Destination unreachable</em>: sent by the router or host that detects the datagram cannot be delivered to its destination.
The code provides more specific reasons.</p></li>
<li><p><em>Source quench</em>: a very basic congestion/flow control mechanism. Requests to the source to reduce the data rate.</p></li>
<li><p><em>Time exceeded</em>: sent by the router to indicate that found a TTL set to 0 or by a destination host where a fragmentation timeout expired (e.g. some piece is missing).</p></li>
<li><p><em>Parameter problem</em>: sent by the router or host indicating that a datagram was malformed or has missing fields.</p></li>
<li><p><em>Redirect</em>: typically sent by routers to hosts to inform them that there are better routes for an IP datagram.
The host could update its routing table after receiving that information.
For example, for a specific datagram, there might be a better route than the one used by a host.</p></li>
</ul>
</section>
<section id="requests">
<h4>Requests<a class="headerlink" href="#requests" title="Link to this heading">#</a></h4>
<p>Some examples of ICMP requests and replies:</p>
<ul class="simple">
<li><p><em>Echo</em>: used to verify connectivity between 2 nodes. An Echo Request is replied by an Echo Reply.</p></li>
<li><p><em>Timestamp</em>: used to measure latency between 2 nodes.</p></li>
<li><p><em>Address mask</em>: used by a host to query the network address mask to use to a router.</p></li>
<li><p><em>Router Solicitation</em>: used by a host to identify what local routers are available around it.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The example of <code class="docutils literal notranslate"><span class="pre">ping</span> <span class="pre">google.com</span></code> shows how to measure the round trip time (RTT).
This is the time between the Echo Request is sent and the Echo Reply is received.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See the code of ping in Scapy <a class="reference download internal" download="" href="_downloads/9358dda2f84b4aec0f06f5cc3b502438/ping.py"><span class="xref download myst">here</span></a>.</p>
</div>
</section>
</section>
<section id="dhcp">
<h3>DHCP<a class="headerlink" href="#dhcp" title="Link to this heading">#</a></h3>
<p>Dynamic Host Configuration Protocol (DHCP) is an application-layer protocol for assigning IP addresses to hosts automatically.
It follows the <em>client-server</em> paradigm where the hosts (clients) request to the DHCP servers to be assigned with a configuration.
This configuration usually includes:</p>
<ul class="simple">
<li><p>An IP address.</p></li>
<li><p>A network mask.</p></li>
<li><p>A default gateway.</p></li>
<li><p>A set of DNS name servers.</p></li>
</ul>
<p>Less fequently the configuration can also include:</p>
<ul class="simple">
<li><p>A hostname.</p></li>
<li><p>Date and time.</p></li>
</ul>
<p>The format of a DHCP message is based on BOOTP as it was already widely used at the time DHCP was desgined:</p>
<ul class="simple">
<li><p><em>Operation code</em>: 1 byte for telling if the message is a request or a reply.</p></li>
<li><p><em>HW type</em>: 1 byte to specify the hardware transmission medium.</p></li>
<li><p><em>HW address length</em>: 1 byte to specify how many bytes the hardware address is long. For Ethernet, this values is 6.</p></li>
<li><p><em>Hop count</em>: 1 byte to control the number of forwardings done by DHCP relays. Very similat to IP’s TTL.</p></li>
<li><p><em>Transaction ID</em>: 4 bytes for an ID of the transaction. Randomly initialised by the client and repeated by the server.</p></li>
<li><p><em>Time elapsed</em>: 2 bytes to inform the number seconds since the client started.</p></li>
<li><p><em>Flags</em>: 2 bytes for flags. The first bit indicates if the message is unicast or multicast.</p></li>
<li><p><em>Client IP address</em>: the client IP. If the client does not know it, then <code class="docutils literal notranslate"><span class="pre">0.0.0.0</span></code> is used.</p></li>
<li><p><em>Your IP address</em>: the assigned client IP. This is set by the server.</p></li>
<li><p><em>Server IP address</em>: the server IP. If the client does not know it, then <code class="docutils literal notranslate"><span class="pre">255.255.255.255</span></code> is used.</p></li>
<li><p><em>Gateway IP address</em>: the default gateway associated to the network the client should use.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The example of the DHCP operations can be explained as follows:</p>
<ol class="arabic simple">
<li><p>The client creates a <code class="docutils literal notranslate"><span class="pre">DHCPDISCOVER</span></code>. It does not know what DHCP servers are around.
The message is sent to the broadcast address. Note that the source port and the destination port are fixec (68 and 67).
We will see later why.</p></li>
<li><p>Every server that receieved the <code class="docutils literal notranslate"><span class="pre">DHCPDISCOVER</span></code> might reply with a <code class="docutils literal notranslate"><span class="pre">DHCPOFFER</span></code>.
This message gives the client a possible configuration to use.
Since the client does not have an IP yet, this message is sent to the broadcast address too.</p></li>
<li><p>The client might receive many <code class="docutils literal notranslate"><span class="pre">DHCPOFFER</span></code>. After that, it would select one of them and create a <code class="docutils literal notranslate"><span class="pre">DHCPREQUEST</span></code>.
This request goes straight to the server that gave the offer to make sure that the configuration provided can be used for up-to <code class="docutils literal notranslate"><span class="pre">3600</span></code> seconds.</p></li>
<li><p>The server replies with a <code class="docutils literal notranslate"><span class="pre">DHCPACK</span></code> meaning that agrees with client’s configuration request.</p></li>
<li><p>When the <code class="docutils literal notranslate"><span class="pre">DHCPACK</span></code> is received by the client, it can assume that it will be <em>bound</em> for that IP address for the leased time period.</p></li>
</ol>
<p>DHCP uses the fixed source port 68 in order to prevent other UDP applications to receive DHCP messages from servers.
Suppose an ephemeral port 12345 is used instead of 68.
If there is an UDP application running somewhere in the network at the same port,
the <code class="docutils literal notranslate"><span class="pre">DHCPOFFER</span></code> messages will arrive to this application too because they are all sent to the broadcast address.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The state diagram shows how DHCP works. It is worth noting that the IP addresses are leased for a certain period of time.
It’s client’s reponsibility to renew these leases on time.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">dhclient</span> <span class="pre">-v</span></code> to see how the DHCP client starts the renewal of the configuration.
Note that it will go to all interfaces of the computer.</p>
</div>
</section>
</section>
<section id="ip-routing">
<h2>IP routing<a class="headerlink" href="#ip-routing" title="Link to this heading">#</a></h2>
<p>In this section we are going to focus on how the hosts and routers manage the IP datagrams so they can reach their destination.</p>
<section id="delivery-methods">
<h3>Delivery methods<a class="headerlink" href="#delivery-methods" title="Link to this heading">#</a></h3>
<p>Every host of an IP network keeps a <em>routing table</em>.
This table contains the required information for sending IP datagrams based on their destination address.
The format of this table is as follows:</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Net Address</p></th>
<th class="head"><p>Mask</p></th>
<th class="head"><p>Delivery Method</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>11.11.11.0</p></td>
<td><p>24</p></td>
<td><p>10.0.0.5</p></td>
</tr>
<tr class="row-odd"><td><p>10.0.0.0</p></td>
<td><p>8</p></td>
<td><p>direct</p></td>
</tr>
</tbody>
</table>
<p>In this example, there are 2 entries that can be read like this:</p>
<ol class="arabic simple">
<li><p>Any datagram sent to the 11.11.11.0/24 network (for example, to 11.11.11.45) should be sent to 10.0.0.5.
This is likely to be a router that knows how to reach the destination host.</p></li>
<li><p>Any datagram sent to the 10.0.0.0/8 network (for example, to 10.10.0.1), it should be delivered directly.
This means that the destination host is in the same network, so no need to send it to a router.</p></li>
</ol>
<p>More formally, there are 2 delivery methods:</p>
<ul class="simple">
<li><p><em>Direct</em>: if a datagram’s destination is in the same network of the processing node then it is direct delivery.</p></li>
<li><p><em>Indirect</em>: the rest. This uses a <em>next-hop</em> address where datagrams will be sent.</p></li>
</ul>
</section>
<section id="forwarding">
<h3>Forwarding<a class="headerlink" href="#forwarding" title="Link to this heading">#</a></h3>
<p>Forwarding is the mechanismin where an IP datagram <em>is moved from one path to another</em> during a route from its source to destation.
This requires:</p>
<ul class="simple">
<li><p>A <em>router</em>: which will move the datagram from one network to another.</p></li>
<li><p>A <em>routing table</em>: which contains the information about the possible routes.
Routers will query the routing table to make a decision about a specific datagram based on its destination address.</p></li>
</ul>
<section id="methods">
<h4>Methods<a class="headerlink" href="#methods" title="Link to this heading">#</a></h4>
<p>There are multiple methods that can implement a forwarding mechanism.
In this section we are going to compare some of them, listing the its pros and cons.</p>
<ul>
<li><p><em>Route method</em> vs <em>Next-hop method</em>: for each destination we could store:</p>
<ul class="simple">
<li><p>The entire route: meaning that <code class="docutils literal notranslate"><span class="pre">A</span></code> needs to know <code class="docutils literal notranslate"><span class="pre">R1</span></code>, <code class="docutils literal notranslate"><span class="pre">R2</span></code> and finally <code class="docutils literal notranslate"><span class="pre">B</span></code>.</p></li>
<li><p>Just the next hop: meaning that <code class="docutils literal notranslate"><span class="pre">A</span></code> only needs to know <code class="docutils literal notranslate"><span class="pre">R1</span></code>.
Note that <code class="docutils literal notranslate"><span class="pre">R2</span></code>’s next hop for reaching <code class="docutils literal notranslate"><span class="pre">B</span></code> is null because it would be direct delivery.</p></li>
</ul>
<p>Obviously, the next-hop method simplifies the routing tables that routers need to keep, so it seems a much better option.
However, there is something good of having the entire route in the routing table: the context that the router has is bigger and could make smarter decisions (like foreseeing problematic branches).
In any case, route method requires so much space and complexity to keep the routes up-to-date that it is not worth to implement.</p>
</li>
<li><p><em>Host-specific</em> vs <em>Network-specific</em>: the destinations can be:</p>
<ul class="simple">
<li><p>All the possible hosts: this means that <code class="docutils literal notranslate"><span class="pre">S</span></code> will have to store one row for <code class="docutils literal notranslate"><span class="pre">A</span></code>, <code class="docutils literal notranslate"><span class="pre">B</span></code>, <code class="docutils literal notranslate"><span class="pre">C</span></code>, and <code class="docutils literal notranslate"><span class="pre">D</span></code>.</p></li>
<li><p>Just the destination network: meaning that <code class="docutils literal notranslate"><span class="pre">S</span></code> will only need to store the destination network address to know how to each <em>any</em> node from that network.</p></li>
</ul>
<p>Network-specific approach is better because simplifies the routing table and the process of updating them.</p>
</li>
<li><p><em>Default route</em>: a node or a router can be connected to a network that provide access to multiple inter-networks (like the Internet).
We cannot store all the possible destination networks in our table.
For that reason, the <em>default</em> route can be placed at the end of the forwarding table.
If the route for a given destination address is not found then the datagram will be forwarded to the next hop that pointed by the default route.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We can define a forwarding mechanism in pseudo-code:</p>
<ol class="arabic simple">
<li><p>Get the destination address of the datagram.</p></li>
<li><p>Loop through each row of the routing table.</p></li>
<li><p>Perform an <code class="docutils literal notranslate"><span class="pre">AND</span></code> operation between the destination address and the network mask specified in the row.</p></li>
<li><p>If the result is equals to destination value of the row, then forward the datagram to the next hop.</p></li>
<li><p>If no row matched and there is a default route, then follow the default route.</p></li>
<li><p>If there is no a default route, then return an ICMP error stating that there is not a route for the given datagram.</p></li>
</ol>
</div>
</section>
</section>
<section id="routing-tables">
<h3>Routing tables<a class="headerlink" href="#routing-tables" title="Link to this heading">#</a></h3>
<p>Given the previous procedure, each row in the routing table should contain the following fields:</p>
<ul class="simple">
<li><p><em>Destination network address</em>: required to know what network address the route goes to.</p></li>
<li><p><em>Destination network mask</em>: required so the <code class="docutils literal notranslate"><span class="pre">AND</span></code> operation can be performed.</p></li>
<li><p><em>Next-hop address</em>: required to know what node will handle a matched datagram for this specific route.</p></li>
<li><p><em>Interface</em>: required to know through what interface the forwarded datagram should be sent.</p></li>
</ul>
<p>The next-hop address and the interface is used downstream by ARP,
a link-layer protocol that translates an IP address to a link-layer address.
The link-layer address can be used by the link-layer to send frames containing the IP datagram.
We will study ARP in more detail in the following chapter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The example shows the routing table of the second router that has 2 interfaces: <code class="docutils literal notranslate"><span class="pre">eth0</span></code> and <code class="docutils literal notranslate"><span class="pre">eth1</span></code>.
<code class="docutils literal notranslate"><span class="pre">eth0</span></code> is connected to 40.0.0.0/8 network and its assigned IP is 40.0.0.8.
<code class="docutils literal notranslate"><span class="pre">eth1</span></code> is connected to 128.1.0.0/16 network and its assigned IP is 128.1.0.8.</p>
<p>Any datagram to any of the these networks will be considered for <em>direct delibery</em> because the router is connected to them.
However datagrams to 30.0.0.0/8 network will need to be sent to 40.0.0.7 which has access to that network.
Datagrams to 192.4.10.0/24  will need to be sent to 128.1.0.9 for the same reason.</p>
<p>It is important to note that any other destination address, like 8.8.8.8, will generate an ICMP error because there is no route for it.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The next example shows the routing table of R1 which has 3 interfaces.
In this case, a default route is configured.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Based on the previous example, let’s explain what it would happen if a datagram arrives to R1 with destionation address 180.70.65.140:</p>
<ol class="arabic">
<li><p>The first row’s mask would be applied to the destination address:</p>
<p>180.70.65.140 &amp; 255.255.255.192 = 180.70.65.128</p>
<p>It does not match the first row’s destination field.</p>
</li>
<li><p>The second row’s mask would be applied to the destination address:</p>
<p>180.70.65.140 &amp; 255.255.255.128 = 180.70.65.128</p>
<p>In this case, it matches so the next-hop address and the interface is passed to ARP.</p>
</li>
</ol>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Based on the previous example, let’s explain what it would happen if a datagram arrives to R1 with destionation address 201.4.22.35:</p>
<ol class="arabic">
<li><p>The first row’s mask would be applied to the destination address:</p>
<p>201.4.22.35 &amp; 255.255.255.192 = 201.4.22.0</p>
<p>It does not match the first row’s destination field.</p>
</li>
<li><p>The second row’s mask would be applied to the destination address:</p>
<p>201.4.22.35 &amp; 255.255.255.128 = 201.4.22.0</p>
<p>It does not match the first row’s destination field.</p>
</li>
<li><p>The third row’s mask would be applied to the destination address:</p>
<p>201.4.22.35 &amp; 255.255.255.0 = 201.4.22.0</p>
<p>In this case, the result matches so the next-hop address and the interface is passed to ARP.</p>
</li>
</ol>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Based on the previous example, let’s explain what it would happen if a datagram arrives to R1 with destionation address 18.24.32.78:</p>
<p>All rows in the table will be queried and no one will provide a match except the latest one: the default route.</p>
</div>
<p>Now that each destination network address and mask need to be kept on each row,
one can think that in a real environment with lots of networks,
routers might need to keep lot of destination networks if neighbours are connected to multiple networks.</p>
<p>However, routers can use <em>address aggregation</em> to simplify their routing tables.
Many network addresses can be collapsed into just one that includes many of them.
That way, only one table row is required to reach multiple networks.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the example, R1 is connected to 4 networks, all of them /26.
R2 does not need to know all those networks, it only needs one row for 140.24.7.0/24.</p>
<p>And it is /24 because R1 uses 2 bits for subnetting (/24 + 2 = /26).</p>
</div>
<p>However, address aggregation introduces a new problem.
What if one of the 4 networks is removed from R1 (for example, 140.24.7.192/26)  and now it is placed in a separated router.
Now R2 seems like it will not be able to use 140.24.7.0/24 in just one row.
It will need 2 rows: one for 140.24.7.0/24 and one for 140.24.7.192/26 because each of them are connected to different interfaces.
But one includes the other so both will match.</p>
<p>In order to disambiguate what row to pick the <em>longest mask matching</em> criteria will be followed.
This means that the row in the routing table whose mask is the longest will be selected in case there are others shorter.
In our case, <code class="docutils literal notranslate"><span class="pre">/26</span></code> is longer than <code class="docutils literal notranslate"><span class="pre">/24</span></code> so both rows can coexist without any problem in R2.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To see how this address aggregation provides a hierarchical routing, let’s consider the following example:</p>
<ul>
<li><p>A regional ISP is assigned with 120.14.64.0/18. This means that it has <span class="math notranslate nohighlight">\(2^{16}\)</span> addresses.</p></li>
<li><p>This ISP divides this block in 4 to give each block to local 3 ISPs
It needs 2 bits for subnetting. One block will not be used but the other 3 will be assigned to the local ISPs:</p>
<ol class="arabic">
<li><p>120.14.64.0/20: this local ISP subdivide this block in 8 subnetworks that will be assigned to small providers.
That requires 3 bits so the result in /23 networks:</p>
<ul class="simple">
<li><p>120.14.64.0/23, to</p></li>
<li><p>120.14.78.0/23</p></li>
</ul>
<p>And each of these small ISPs divide them into 128 blocks that will be assigned to households.
That requires 7 bits, so the resulting networks will be /30:</p>
<ul class="simple">
<li><p>120.14.64.0/30 - …, to</p></li>
<li><p>120.14.78.0/30 - …</p></li>
</ul>
</li>
<li><p>120.14.80.0/20: not assigned and reserved for future use.</p></li>
<li><p>120.14.96.0/20: this local ISP breaks down the network in 4 subnetworks, resulting in /22.</p></li>
<li><p>120.14.112.0/20: this local ISP breaks down the network in 16 subnetworks, resulting in /24.</p></li>
</ol>
</li>
</ul>
</div>
<p>In GNU/Linux there are tools that can be used for querying the routing table and the host configuration.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">route</span></code>: shows the routing table.
This can be also done with <code class="docutils literal notranslate"><span class="pre">route</span></code> or <code class="docutils literal notranslate"><span class="pre">netstat</span> <span class="pre">-rn</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ip</span> <span class="pre">addr</span> <span class="pre">show</span></code>: shows the interface configuration (its IP address, network mask and much more).
This can be also done with <code class="docutils literal notranslate"><span class="pre">ifconfig</span></code>.</p></li>
</ul>
</section>
<section id="dynamic-routing">
<h3>Dynamic routing<a class="headerlink" href="#dynamic-routing" title="Link to this heading">#</a></h3>
<p>Each row of the routing tables represent a route that can be reachable from the host or router where the routing table lives.
The routes can be added and removed manually from the routing table.
However, that will not provide a good user experience as the Internet is constantly changes.
There are nodes that are not available anymore and new routes that can be used very frequently.</p>
<p>In order to update the routes automatically, we will need a <em>routing protocol</em> between routing nodes so they can configure themselves.
With this type of protocols, routing nodes can discover new routes from their neighbours, announce a faulty path, etc.</p>
<p>As mentioned, these routing protocols are used between routing nodes. Specifically, they are effective at the level of <em>autonomous systems</em> (AS).
The Internet is built out of autonomous systems can be a single big network of a set of networks of networks.
The main point of an AS is that it defines a single routing policy and owns a set of IPs (its IP address space).
An <em>AS number</em> (ASN) is assigned to each AS that is connected to the Internet.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the slide there is 4 AS that are interconnected.
Some routers within the AS can connect to external AS routers.</p>
</div>
<p>The routing protocols can be:</p>
<ul class="simple">
<li><p><em>Intra-domain</em>: they are used within an AS (domain). The most common one are:</p>
<ul>
<li><p><em>RIP</em>: <em>Routing Information Protocol</em> is based on the distance vector algorithms that tries to get the best route to a destination based on the number hops and other metrics.x</p></li>
<li><p><em>OSPF</em>: <em>Open Shortest Path First</em> builds a database of the link status with a <em>cost</em> metric.</p></li>
</ul>
</li>
<li><p><em>Inter-domain</em>: they are used between AS (domains). Here it is used BGP (<em>Border Gateway Protocol</em>) where routes are announced and routers take that information for keeping their tables up-to-date.
BGP allows having multiple route selection with different weights.</p></li>
</ul>
</section>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<blockquote>
<div><p>TBD</p>
</div></blockquote>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="transport.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Transport layer</p>
      </div>
    </a>
    <a class="right-next"
       href="data-link.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Data-link layer</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ip-protocol">IP protocol</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#format">Format</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#fragmentation">Fragmentation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#addressing">Addressing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#subnetting">Subnetting</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration-and-management-protocols">Configuration and management protocols</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#icmp">ICMP</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#errors">Errors</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#requests">Requests</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dhcp">DHCP</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ip-routing">IP routing</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#delivery-methods">Delivery methods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#forwarding">Forwarding</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#methods">Methods</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#routing-tables">Routing tables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dynamic-routing">Dynamic routing</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Cleto Martín
</p>

  </div>
  
  <div class="footer-item">
    

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>